<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Interface</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }

      .chat-message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.75rem;
        word-wrap: break-word;
        position: relative;
        max-width: 80%;
        transition: all 0.3s ease;
      }

      .chat-message:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .user-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
        font-weight: 500;
      }

      .bot-message {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        margin-right: auto;
        border-bottom-left-radius: 0.25rem;
        font-weight: 500;
      }

      .message-timestamp {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
      }

      .loading-indicator {
        display: none;
        text-align: center;
        padding: 1rem;
        color: #6c757d;
      }

      .loading-dots {
        display: inline-block;
      }

      .loading-dots::after {
        content: "";
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: "";
        }
        40% {
          content: ".";
        }
        60% {
          content: "..";
        }
        80%,
        100% {
          content: "...";
        }
      }

      .error-message {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .welcome-message {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        text-align: center;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
        padding: 1.5rem !important;
        border-radius: 1rem;
      }

      .quick-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
        margin: 1rem 0;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
      }

      .quick-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }

      .quick-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .quick-btn:active {
        transform: translateY(0);
      }

      .typing-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        30% {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
  </head>

  <body>
    <div class="container mt-5">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4>ü§ñ Your Friendly Assistant</h4>
        </div>
        <div
          class="card-body"
          id="chat-messages"
          style="height: 500px; overflow-y: auto"
        >
          <div class="loading-indicator" id="loading-indicator">
            <div class="typing-indicator">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <form id="chat-form" method="POST">
            {% csrf_token %}
            <div class="input-group">
              <input
                type="text"
                id="user-input"
                name="user-input"
                class="form-control"
                placeholder="Type your message here..."
                autocomplete="off"
                required
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                id="mic-button"
                title="Hold to speak"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-mic-fill"
                  viewBox="0 0 16 16"
                >
                  <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z" />
                  <path
                    d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 13V7a.5.5 0 0 1 .5-.5z"
                  />
                </svg>
              </button>
              <button class="btn btn-primary" type="submit" id="send-button">
                Send
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <script>
      const chatForm = document.getElementById("chat-form");
      const userInput = document.getElementById("user-input");
      const chatMessages = document.getElementById("chat-messages");
      const micButton = document.getElementById("mic-button");
      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]",
      ).value;

      let mediaRecorder;
      let audioChunks = [];
      let isRecording = false;

      // --- Voice Logic ---

      // Check for microphone support
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        setupAudio();
      } else {
        micButton.style.display = "none";
      }

      async function setupAudio() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            audioChunks = [];
            await sendAudio(audioBlob);
          };

          // Setup button listeners
          micButton.addEventListener("mousedown", startRecording);
          micButton.addEventListener("mouseup", stopRecording);
          micButton.addEventListener("mouseleave", stopRecording);

          // Touch events for mobile
          micButton.addEventListener("touchstart", (e) => {
            e.preventDefault();
            startRecording();
          });
          micButton.addEventListener("touchend", (e) => {
            e.preventDefault();
            stopRecording();
          });
        } catch (err) {
          console.error("Error accessing microphone:", err);
          micButton.style.display = "none";
        }
      }

      function startRecording() {
        if (isRecording) return;
        isRecording = true;
        audioChunks = [];
        mediaRecorder.start();
        micButton.classList.remove("btn-outline-secondary");
        micButton.classList.add("btn-danger");
      }

      function stopRecording() {
        if (!isRecording) return;
        isRecording = false;
        mediaRecorder.stop();
        micButton.classList.remove("btn-danger");
        micButton.classList.add("btn-outline-secondary");
      }

      async function sendAudio(audioBlob) {
        // Show temporary loading
        displayMessage(
          "üé§ Processing audio...",
          true,
          false,
          false,
          null,
          false,
        );
        const tempMsg = chatMessages.lastElementChild;
        showLoading();

        const formData = new FormData();
        formData.append("audio", audioBlob, "voice.webm");

        try {
          const response = await fetch("/api/transcribe/", {
            method: "POST",
            body: formData,
          });

          // Remove temp message
          tempMsg.remove();
          hideLoading();

          if (!response.ok) throw new Error("Transcription failed");

          const data = await response.json();
          if (data.text) {
            userInput.value = data.text;
            // Auto-submit
            chatForm.dispatchEvent(new Event("submit"));
          }
        } catch (error) {
          console.error("Audio error:", error);
          tempMsg.textContent = "Error processing audio.";
          setTimeout(() => tempMsg.remove(), 2000);
          hideLoading();
        }
      }

      function speakText(text) {
        if ("speechSynthesis" in window) {
          // Cancel any ongoing speech
          window.speechSynthesis.cancel();

          // Create utterance
          // Strip markdown / code blocks mostly for cleaner speech
          const cleanText = text
            .replace(/```[\s\S]*?```/g, "Code block omitted.")
            .replace(/[*#_`]/g, "");

          const utterance = new SpeechSynthesisUtterance(cleanText);
          utterance.rate = 1.0;
          utterance.pitch = 1.0;
          window.speechSynthesis.speak(utterance);
        }
      }

      // --- End Voice Logic ---

      // Conversation persistence
      const STORAGE_KEY = "chatbot_conversation";
      const MAX_MESSAGES = 50; // Limit stored messages

      // Load conversation history on page load
      function loadConversation() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const messages = JSON.parse(saved);
            messages.forEach((msg) => {
              displayMessage(
                msg.text,
                msg.isUser,
                msg.isError,
                msg.isFallback,
                msg.timestamp,
                false,
              );
            });
          } catch (e) {
            console.error("Failed to load conversation:", e);
          }
        }
      }

      // Save conversation to localStorage
      function saveConversation() {
        const messages = [];
        const messageElements = chatMessages.querySelectorAll(".chat-message");

        messageElements.forEach((element) => {
          const textElement = element.querySelector("div:first-child");
          const timestampElement = element.querySelector(".message-timestamp");
          const fallbackElement = element.querySelector(".fallback-indicator");

          // Skip temp messages or welcome
          if (element.classList.contains("welcome-message")) return;

          messages.push({
            text: textElement.textContent,
            isUser: element.classList.contains("user-message"),
            isError: element.classList.contains("error-message"),
            isFallback: fallbackElement !== null,
            timestamp: timestampElement
              ? timestampElement.textContent
              : new Date().toLocaleTimeString(),
          });
        });

        // Keep only the last MAX_MESSAGES
        if (messages.length > MAX_MESSAGES) {
          messages.splice(0, messages.length - MAX_MESSAGES);
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      }

      // Clear conversation history
      function clearConversation() {
        localStorage.removeItem(STORAGE_KEY);
        chatMessages.innerHTML = "";
        // Re-show welcome
        displayWelcomeMessage();
      }

      function displayMessage(
        message,
        isUser = false,
        isError = false,
        isFallback = false,
        timestamp = null,
        shouldSave = true,
        fallbackReason = null,
        agent = null,
      ) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("chat-message");

        if (isUser) {
          messageDiv.classList.add("user-message");
        } else if (isError) {
          messageDiv.classList.add("bot-message", "error-message");
        } else {
          messageDiv.classList.add("bot-message");
          // Auto-speak bot messages
          if (!isError && shouldSave) {
            // Don't speak history loads
            speakText(message);
          }
        }

        // Message content container
        const messageContent = document.createElement("div");

        // Add Agent Badge if present and not user
        if (!isUser && !isError && agent) {
          messageContent.innerHTML = getAgentBadge(agent);
        }

        // Append text (safely)
        const textSpan = document.createElement("span");
        textSpan.textContent = message;
        messageContent.appendChild(textSpan);

        messageDiv.appendChild(messageContent);

        // Add timestamp
        const timestampDiv = document.createElement("div");
        timestampDiv.classList.add("message-timestamp");
        timestampDiv.textContent = timestamp || new Date().toLocaleTimeString();
        messageDiv.appendChild(timestampDiv);

        // Add fallback indicator if needed
        if (isFallback) {
          const fallbackIndicator = document.createElement("div");
          fallbackIndicator.classList.add("fallback-indicator");
          const shortReason =
            fallbackReason && fallbackReason.length > 50
              ? fallbackReason.substring(0, 47) + "..."
              : fallbackReason;
          fallbackIndicator.textContent = shortReason
            ? `Using fallback: ${shortReason}`
            : "Using fallback response";
          fallbackIndicator.title = fallbackReason || "AI service unavailable";
          messageDiv.appendChild(fallbackIndicator);
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Save conversation after adding message
        if (shouldSave) {
          saveConversation();
        }
      }

      function showLoading() {
        document.getElementById("loading-indicator").style.display = "block";
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function hideLoading() {
        document.getElementById("loading-indicator").style.display = "none";
      }

      // Initialize conversation on page load
      document.addEventListener("DOMContentLoaded", () => {
        loadConversation();

        // Add welcome message if no conversation exists
        if (chatMessages.querySelectorAll(".chat-message").length === 0) {
          displayWelcomeMessage();
        }

        // Add clear conversation button
        const header = document.querySelector(".card-header");
        // Remove existing clean btn if any to prevent duplicates on reload
        const existingBtn = header.querySelector("button");
        if (existingBtn) existingBtn.remove();

        const clearBtn = document.createElement("button");
        clearBtn.className = "btn btn-sm btn-outline-light float-end";
        clearBtn.textContent = "Clear Chat";
        clearBtn.onclick = clearConversation;
        header.appendChild(clearBtn);
      });

      function displayWelcomeMessage() {
        const welcomeDiv = document.createElement("div");
        welcomeDiv.classList.add(
          "chat-message",
          "bot-message",
          "welcome-message",
        );

        const welcomeContent = document.createElement("div");
        welcomeContent.innerHTML =
          "üëã Hey there! Welcome! I'm so excited to help you today! What can I do for you?";
        welcomeDiv.appendChild(welcomeContent);

        const timestampDiv = document.createElement("div");
        timestampDiv.classList.add("message-timestamp");
        timestampDiv.textContent = new Date().toLocaleTimeString();
        welcomeDiv.appendChild(timestampDiv);

        // Add quick action buttons
        const buttonsDiv = document.createElement("div");
        buttonsDiv.classList.add("quick-buttons");
        buttonsDiv.innerHTML = `
                <button class="quick-btn" onclick="sendQuickMessage('contact')">üìû Contact Info</button>
                <button class="quick-btn" onclick="sendQuickMessage('services')">üíº Our Services</button>
                <button class="quick-btn" onclick="sendQuickMessage('hours')">‚è∞ Business Hours</button>
                <button class="quick-btn" onclick="sendQuickMessage('location')">üìç Location</button>
                <button class="quick-btn" onclick="sendQuickMessage('human')">üí¨ Talk to Human</button>
            `;
        welcomeDiv.appendChild(buttonsDiv);

        chatMessages.appendChild(welcomeDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendQuickMessage(message) {
        userInput.value = message;
        chatForm.dispatchEvent(new Event("submit"));
      }

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Stop TTS when sending new message
        window.speechSynthesis.cancel();

        const message = userInput.value.trim();
        if (message === "") return;

        // Disable form and show loading
        const sendButton = document.getElementById("send-button");
        const originalButtonText = sendButton.textContent;
        sendButton.disabled = true;
        sendButton.textContent = "Sending...";
        userInput.disabled = true;

        displayMessage(message, true);
        userInput.value = "";
        showLoading();

        try {
          const response = await fetch("", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrfToken,
            },
            body: `user-input=${encodeURIComponent(message)}`,
          });

          if (!response.ok) {
            throw new Error(
              `Server returned ${response.status}: ${response.statusText}`,
            );
          }

          const data = await response.json();

          // Handle different response types
          if (data.fallback) {
            displayMessage(
              data.message,
              false,
              false,
              true,
              null,
              true,
              data.fallback_reason,
            );
          } else if (data.error) {
            displayMessage(data.message, false, true);
          } else {
            displayMessage(
              data.message,
              false,
              false,
              false,
              null,
              true,
              null,
              data.agent,
            );
          }
        } catch (error) {
          console.error("Error:", error);
          displayMessage(
            "Connection error. Please check your internet connection and try again.",
            false,
            true,
          );
        } finally {
          // Re-enable form and hide loading
          hideLoading();
          sendButton.disabled = false;
          sendButton.textContent = originalButtonText;
          userInput.disabled = false;
          userInput.focus();
        }
      });

      // Allow Enter key to send message
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(new Event("submit"));
        }
      });

      function getAgentBadge(agent) {
        if (!agent) return "";
        let badgeClass = "bg-secondary";
        let icon = "ü§ñ";
        switch (agent.toLowerCase()) {
          case "coder":
            badgeClass = "bg-success";
            icon = "üë®‚Äçüíª";
            break;
          case "researcher":
            badgeClass = "bg-info text-dark";
            icon = "üîç";
            break;
          case "generalist":
            badgeClass = "bg-primary";
            icon = "ü§ñ";
            break;
        }
        return `<span class="badge ${badgeClass} mb-1" style="font-size: 0.7rem;">${icon} ${
          agent.charAt(0).toUpperCase() + agent.slice(1)
        }</span><br>`;
      }
    </script>
  </body>
</html>
